import React, { ChangeEvent, useState } from "react";
import ReactDOM from "react-dom/client";
import { BrowserRouter, Route, Routes, useNavigate } from "react-router-dom";
import { ThunkAction, ThunkDispatch } from "redux-thunk";
import { Provider, TypedUseSelectorHook, useDispatch, useSelector } from "react-redux";
import axios from "axios";
import { configureStore, combineReducers } from "@reduxjs/toolkit";

// Types
type LoginFieldsType = {
    email: string;
    password: string;
};

// API
const instance = axios.create({ baseURL: "https://exams-frontend.kimitsu.it-incubator.ru/api/" });

const api = {
    login(data: LoginFieldsType) {
        return instance.post("auth/login", data);
    },
};

// Reducer
const initState = { isAuth: false };
type InitStateType = typeof initState;

const appReducer = (state: InitStateType = initState, action: ActionsType): InitStateType => {
    switch (action.type) {
        case "SET_AUTH":
            return { ...state, isAuth: action.isAuth };
        default:
            return state;
    }
};

// Store
const rootReducer = combineReducers({ app: appReducer });

const store = configureStore({ reducer: rootReducer });
type RootState = ReturnType<typeof store.getState>;
type AppDispatch = ThunkDispatch<RootState, unknown, ActionsType>;
type AppThunk<ReturnType = void> = ThunkAction<ReturnType, RootState, unknown, ActionsType>;
const useAppDispatch = () => useDispatch<AppDispatch>();
const useAppSelector: TypedUseSelectorHook<RootState> = useSelector;

const setAuth = (isAuth: boolean) => ({ type: "SET_AUTH", isAuth }) as const;
type ActionsType = ReturnType<typeof setAuth>;

// Thunk
const loginTC =
    (email: string, password: string): AppThunk =>
        async (dispatch) => {
            try {
                await api.login({ email, password });
                dispatch(setAuth(true));
            } catch (e: any) {
                alert(`âŒ ${e.response.data.errors} âŒ`);
            }
        };

// Components
const Login = () => {
    const isAuth = useAppSelector((state) => state.app.isAuth);

    const dispatch = useAppDispatch();

    const navigate = useNavigate();

    const [email, setEmail] = useState("darrell@gmail.com");
    const [password, setPassword] = useState("123");

    const changeEmailHandler = (e: ChangeEvent<HTMLInputElement>) => {
        setEmail(e.target.value);
    };

    const changePasswordHandler = (e: ChangeEvent<HTMLInputElement>) => {
        setPassword(e.target.value);
    };

    if (isAuth) {
        navigate("/profile");
    }

    return (
        <div>
            <input type={"text"} value={email} onChange={changeEmailHandler} />
            <input type={"password"} value={password} onChange={changePasswordHandler} />
            <button disabled={!email || !password} onClick={()=>{dispatch(loginTC(email, password))}}>login</button>
        </div>
    );
};

export const App = () => {
    return (
        <Routes>
            <Route path={"/"} element={<Login />} />
            <Route path={"/profile"} element={<h2>ðŸ˜Ž Profile</h2>} />
        </Routes>
    );
};

const root = ReactDOM.createRoot(document.getElementById("root") as HTMLElement);
root.render(
    <BrowserRouter>
        <Provider store={store}>
            <App />
        </Provider>
    </BrowserRouter>,
);

// ðŸ“œ ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ:
// â— Email Ð¸ password Ð¼ÐµÐ½ÑÑ‚ÑŒ Ð½Ðµ Ð½Ð°Ð´Ð¾. Ð­Ñ‚Ð¾ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¼Ð¸ Ð±ÑƒÐ´ÐµÑ‚ Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ñ‚ÑŒ ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ.
// ÐŸÐ¾Ð¼Ð¾Ð³Ð¸Ñ‚Ðµ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÑƒ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð´ Ñ‚Ð°Ðº, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð»Ð¾Ð³Ð¸Ð½Ð¸Ñ‚ÑŒÑÑ (Ð¸ Ñ€ÐµÐ´Ð¸Ñ€ÐµÐºÑ‚Ð½ÑƒÑ‚ÑŒÑÑ Ð½Ð° Profile)
// Ð’ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ð° ÑƒÐºÐ°Ð¶Ð¸Ñ‚Ðµ ÐºÐ¾Ð´, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ñ‚ÑŒ Ð´Ð°Ð½Ð½ÑƒÑŽ Ð·Ð°Ð´Ð°Ñ‡Ñƒ.

// ðŸ–¥ ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¾Ñ‚Ð²ÐµÑ‚Ð°: navigate('/profile')
// ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚: dispatch(loginTC(email, password))
// Ð’ÐµÑ€Ð½Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚: onClick={()=>{dispatch(loginTC(email, password))}}